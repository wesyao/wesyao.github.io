<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>MAMBA MENTALITY</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2017-12-05T00:14:58.000Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>Wes Yao</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Kubernetes on Azure in 30 Minutes</title>
    <link href="http://yoursite.com/2017/12/04/kubernetes/kubernetes-on-azure-in-30-min/"/>
    <id>http://yoursite.com/2017/12/04/kubernetes/kubernetes-on-azure-in-30-min/</id>
    <published>2017-12-05T00:05:21.000Z</published>
    <updated>2017-12-05T00:14:58.000Z</updated>
    
    <content type="html"><![CDATA[<p>This guide is meant to streamline you to your first Kubernetes (k8s) cluster on Microsoft Azure, with the essentials to monitor and scale your container service. In the interest of time/reading, this will <strong>NOT</strong> be an indepth tutorial on Kubernetes.</p><h1 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h1><p>We will be using cli tools and package managers to provision azure resources and to manage our clusters.</p><h2 id="Install-Azure-CLI"><a href="#Install-Azure-CLI" class="headerlink" title="Install Azure CLI"></a>Install Azure CLI</h2><p>Azure CLI is used to deploy and manage resources within your azure subscription</p><h3 id="Install-on-Mac-with-Homebrew"><a href="#Install-on-Mac-with-Homebrew" class="headerlink" title="Install on Mac with Homebrew"></a>Install on Mac with Homebrew</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">brew update</div><div class="line">brew install azure-cli</div></pre></td></tr></table></figure><h3 id="Install-on-Windows"><a href="#Install-on-Windows" class="headerlink" title="Install on Windows"></a>Install on Windows</h3><p>Download and run <a href="https://aka.ms/InstallAzureCliWindows" target="_blank" rel="external">Azure CLI Installer (MSI)</a></p><p><a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli?view=azure-cli-latest" target="_blank" rel="external">For more informaion on installing Azure CLI</a></p><h3 id="Install-Kubernetes-CLI-kubectl"><a href="#Install-Kubernetes-CLI-kubectl" class="headerlink" title="Install Kubernetes CLI (kubectl)"></a>Install Kubernetes CLI (kubectl)</h3><p>Kubectl is used to deploy and manage your kubernetes cluster</p><h3 id="Install-on-Mac-with-Homebrew-1"><a href="#Install-on-Mac-with-Homebrew-1" class="headerlink" title="Install on Mac with Homebrew"></a>Install on Mac with Homebrew</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">brew install kubectl</div></pre></td></tr></table></figure><h3 id="Install-on-Windows-1"><a href="#Install-on-Windows-1" class="headerlink" title="Install on Windows"></a>Install on Windows</h3><ol><li>Download latest release from <a href="https://storage.googleapis.com/kubernetes-release/release/v1.8.0/bin/windows/amd64/kubectl.exe" target="_blank" rel="external">here</a></li><li>Add binary to PATH<ul><li>Open Control Panel</li><li>Open Advanced System Properties</li><li>Click Environment Variables</li><li>Edit Path under <strong>System variables</strong></li><li>Add Path to kubectl executable</li></ul></li></ol><p><a href="https://kubernetes.io/docs/tasks/tools/install-kubectl" target="_blank" rel="external">For more information on installing Kubernetes CLI (kubectl)</a></p><h1 id="Setting-up-Azure-Container-Service"><a href="#Setting-up-Azure-Container-Service" class="headerlink" title="Setting up Azure Container Service"></a>Setting up Azure Container Service</h1><p>Create a Resource Group and Create the Azure Container Service within that group. This will create a cluster named MyK8sCluster with 1 linux master and 3 linux agent nodes.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">az group create --name AzureKubernetesTutorial --location westus</div><div class="line">az acs create --orchestrator-type kubernetes --resource-group AzureKubernetesTutorial --name MyK8sCluster --generate-ssh-keys</div></pre></td></tr></table></figure><h1 id="Connect-to-your-Cluster"><a href="#Connect-to-your-Cluster" class="headerlink" title="Connect to your Cluster"></a>Connect to your Cluster</h1><p>Kubernetes CLI needs to be configured to access your cluster from your machine. This command configures your <code>.kube/config</code>.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">az acs kubernetes get-credentials --resource-group=myResourceGroup --name=myK8sCluster</div><div class="line"></div><div class="line">kubectl get nodes</div><div class="line"></div><div class="line">NAME                    STATUS    ROLES     AGE       VERSION</div><div class="line">k8s-agent-631d3265-0    Ready     agent     6d        v1.7.7</div><div class="line">k8s-agent-631d3265-1    Ready     agent     6d        v1.7.7</div><div class="line">k8s-agent-631d3265-2    Ready     agent     6d        v1.7.7</div><div class="line">k8s-master-631d3265-0   Ready     master    6d        v1.7.7</div></pre></td></tr></table></figure><h1 id="Monitoring-your-Cluster"><a href="#Monitoring-your-Cluster" class="headerlink" title="Monitoring your Cluster"></a>Monitoring your Cluster</h1><p>Although k8s will try to keep up your clusters health, proactive monitoring is good for seeing CPU, memory, and disk metrics as well as how your pod is behaving within your cluster.</p><h2 id="Ensure-Heapster-is-installed"><a href="#Ensure-Heapster-is-installed" class="headerlink" title="Ensure Heapster is installed"></a>Ensure Heapster is installed</h2><p>Heapster is a pod in your cluster that is responsible for aggregating monitoring data across all nodes and pods within your cluster. It is necessary to have Heapster for viewing data on Grafana.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">kubectl get pods --namespace=kube-system</div><div class="line"></div><div class="line">NAME                                            READY     STATUS    RESTARTS   AGE</div><div class="line">heapster-342135353-zq0fv                        2/2       Running   0          4d</div><div class="line">kube-addon-manager-k8s-master-631d3265-0        1/1       Running   0          8d</div><div class="line">kube-apiserver-k8s-master-631d3265-0            1/1       Running   0          8d</div><div class="line">kube-controller-manager-k8s-master-631d3265-0   1/1       Running   0          8d</div><div class="line">kube-dns-v20-3003781527-13rws                   3/3       Running   0          8d</div><div class="line">kube-dns-v20-3003781527-n6rj6                   3/3       Running   0          8d</div><div class="line">kube-proxy-3fwdq                                1/1       Running   0          8d</div><div class="line">kube-proxy-7698s                                1/1       Running   0          8d</div><div class="line">kube-proxy-d421d                                1/1       Running   0          8d</div><div class="line">kube-proxy-fvp2m                                1/1       Running   0          8d</div><div class="line">kube-scheduler-k8s-master-631d3265-0            1/1       Running   0          8d</div><div class="line">kubernetes-dashboard-924040265-tflfr            1/1       Running   0          8d</div><div class="line">tiller-deploy-4061877079-d758t                  1/1       Running   0          2h</div></pre></td></tr></table></figure><h2 id="Basic-Node-Metrics-with-Kubectl"><a href="#Basic-Node-Metrics-with-Kubectl" class="headerlink" title="Basic Node Metrics with Kubectl"></a>Basic Node Metrics with Kubectl</h2><p>The fastest way to see metrics about your node is to use kubectl.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">kubectl top node</div><div class="line"></div><div class="line">NAME                    CPU(cores)   CPU%      MEMORY(bytes)   MEMORY%</div><div class="line">k8s-master-631d3265-0   120m         6%        1928Mi          28%</div><div class="line">k8s-agent-631d3265-2    44m          2%        1222Mi          17%</div><div class="line">k8s-agent-631d3265-0    31m          1%        1310Mi          19%</div><div class="line">k8s-agent-631d3265-1    36m          1%        1367Mi          19%</div></pre></td></tr></table></figure><h2 id="Installing-Grafana-and-Influx-DB"><a href="#Installing-Grafana-and-Influx-DB" class="headerlink" title="Installing Grafana and Influx DB"></a>Installing Grafana and Influx DB</h2><ol><li><p>Download InfluxDB deployment manifest by using curl or by going to the <a href="https://raw.githubusercontent.com/kubernetes/heapster/release-1.5/deploy/kube-config/influxdb/influxdb.yaml" target="_blank" rel="external">url</a> and copy and pasting the source</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -o ./influxdb.yaml -k https://raw.githubusercontent.com/kubernetes/heapster/release-1.5/deploy/kube-config/influxdb/influxdb.yaml</div></pre></td></tr></table></figure></li><li><p>Download Grafana deployment manifest by using curl or bu going to the <a href="https://raw.githubusercontent.com/kubernetes/heapster/release-1.5/deploy/kube-config/influxdb/grafana.yaml" target="_blank" rel="external">url</a> and copy and pasting the source</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -o ./grafana.yaml -k https://raw.githubusercontent.com/kubernetes/heapster/release-1.5/deploy/kube-config/influxdb/grafana.yaml</div></pre></td></tr></table></figure></li><li><p>Edit both influxdb.yaml and grafana.yaml and remove </p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#influx.yaml</span></div><div class="line">kubernetes.io/cluster-service: <span class="string">'true'</span></div><div class="line">kubernetes.io/name: monitoring-influxdb</div><div class="line"></div><div class="line"><span class="comment">#grafana.yaml</span></div><div class="line">kubernetes.io/cluster-service: <span class="string">'true'</span></div><div class="line">kubernetes.io/name: monitoring-grafana</div></pre></td></tr></table></figure></li><li><p>Run both influxedb and grafana manifest files. You should see both influxdb and grafana as <code>Running</code> pods in your <code>kube-system</code> namespace. Notice the newly created grafana and influxdb pods.</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">kubectl apply -f influxdb.yaml</div><div class="line">kubectl apply -f grafana.yaml</div><div class="line"></div><div class="line">kubectl get pods --namespace kube-system</div><div class="line">NAME                                            READY     STATUS    RESTARTS   AGE</div><div class="line">heapster-342135353-zq0fv                        2/2       Running   0          4d</div><div class="line">kube-addon-manager-k8s-master-631d3265-0        1/1       Running   0          8d</div><div class="line">kube-apiserver-k8s-master-631d3265-0            1/1       Running   0          8d</div><div class="line">kube-controller-manager-k8s-master-631d3265-0   1/1       Running   0          8d</div><div class="line">kube-dns-v20-3003781527-13rws                   3/3       Running   0          8d</div><div class="line">kube-dns-v20-3003781527-n6rj6                   3/3       Running   0          8d</div><div class="line">kube-proxy-3fwdq                                1/1       Running   0          8d</div><div class="line">kube-proxy-7698s                                1/1       Running   0          8d</div><div class="line">kube-proxy-d421d                                1/1       Running   0          8d</div><div class="line">kube-proxy-fvp2m                                1/1       Running   0          8d</div><div class="line">kube-scheduler-k8s-master-631d3265-0            1/1       Running   0          8d</div><div class="line">kubernetes-dashboard-924040265-tflfr            1/1       Running   0          8d</div><div class="line">monitoring-grafana-1219411114-bmgd8             1/1       Running   0          52s</div><div class="line">monitoring-influxdb-3087546307-wlxgn            1/1       Running   0          1m</div><div class="line">tiller-deploy-4061877079-d758t                  1/1       Running   0          2h</div></pre></td></tr></table></figure></li><li><p>Configure Heapster to use InfluxDB as the data store for your monitoring metrics. Edit your heapster deployment by going under spec &gt; containers &gt; command property and changing the contents from:</p> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="attr">- command:</span></div><div class="line"><span class="bullet">-</span> <span class="string">/heapster</span></div><div class="line"><span class="bullet">-</span> <span class="bullet">--source=kubernetes.summary_api:""</span></div></pre></td></tr></table></figure><p> to</p> <figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attr">- command:</span></div><div class="line"><span class="bullet">-</span> <span class="string">/heapster</span></div><div class="line"><span class="bullet">-</span> <span class="bullet">--source=kubernetes.summary_api:""</span></div><div class="line"><span class="bullet">-</span> <span class="bullet">--sink=influxdb:http://monitoring-influxdb.kube-system.svc:8086</span></div></pre></td></tr></table></figure><p> Save and exit from your editor. This will trigger a change in the deployment. Heapster will restart using InfluxDB as the data store.</p></li><li><p>To verify your Heapster deployment change</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">getHeapster</span></span>() &#123; kubectl get pods -o go-template --template <span class="string">'&#123;&#123;range .items&#125;&#125;&#123;&#123;.metadata.name&#125;&#125;&#123;&#123;"\n"&#125;&#125;&#123;&#123;end&#125;&#125;'</span> --namespace=kube-system | grep -i heapster; &#125;</div><div class="line"></div><div class="line">kubectl logs $(getHeapster) --namespace=kube-system -c heapster</div><div class="line"></div><div class="line">I1130 01:11:32.014809       1 heapster.go:72] /heapster --<span class="built_in">source</span>=kubernetes.summary_api:<span class="string">""</span> --sink=influxdb:http://monitoring-influxdb.kube-system.svc:8086</div><div class="line">I1130 01:11:32.014884       1 heapster.go:73] Heapster version v1.4.2</div><div class="line">I1130 01:11:32.015079       1 configs.go:61] Using Kubernetes client with master <span class="string">"https://10.0.0.1:443"</span> and version v1</div><div class="line">I1130 01:11:32.015091       1 configs.go:62] Using kubelet port 10255</div><div class="line">I1130 01:11:32.023608       1 influxdb.go:278] created influxdb sink with options: host:monitoring-influxdb.kube-system.svc:8086 user:root db:k8s</div><div class="line">I1130 01:11:32.023678       1 heapster.go:196] Starting with InfluxDB Sink</div><div class="line">I1130 01:11:32.023689       1 heapster.go:196] Starting with Metric Sink</div><div class="line">I1130 01:11:32.120803       1 heapster.go:106] Starting heapster on port 8082</div><div class="line">I1130 01:12:05.123163       1 influxdb.go:241] Created database <span class="string">"k8s"</span> on influxDB server at <span class="string">"monitoring-influxdb.kube-system.svc:8086"</span></div></pre></td></tr></table></figure></li></ol><h2 id="Viewing-Grafana-Dashboards"><a href="#Viewing-Grafana-Dashboards" class="headerlink" title="Viewing Grafana Dashboards"></a>Viewing Grafana Dashboards</h2><ol><li>Run <code>kubectl proxy</code></li><li>To view your cluster metrics go to: <a href="http://localhost:8001/api/v1/namespaces/kube-system/services/monitoring-grafana/proxy/dashboard/db/cluster" target="_blank" rel="external">http://localhost:8001/api/v1/namespaces/kube-system/services/monitoring-grafana/proxy/dashboard/db/cluster</a></li><li>To view your pod metrics go to: <a href="http://localhost:8001/api/v1/namespaces/kube-system/services/monitoring-grafana/proxy/dashboard/db/pod" target="_blank" rel="external">http://localhost:8001/api/v1/namespaces/kube-system/services/monitoring-grafana/proxy/dashboard/db/pod</a></li></ol><img src="/2017/12/04/kubernetes/kubernetes-on-azure-in-30-min/grafana.png" alt="grafana.png" title=""><h1 id="Deploying-your-First-Pod"><a href="#Deploying-your-First-Pod" class="headerlink" title="Deploying your First Pod"></a>Deploying your First Pod</h1><p>Now that you have set up monitoring on your cluster, it is time to deploy your first pod. For this example, we will be deploying a simple node app that has already been uploaded to <a href="https://hub.docker.com/r/wesyao/hello-kubernetes-app/" target="_blank" rel="external">dockerhub</a>. Your clusters state is defined through manifest files. K8s will continue checking if the current state is the same as what was defined in the manifest files.</p><ol><li><p>Download the example deployment manifest by using curl or going to the <a href="https://raw.githubusercontent.com/wesyao/hello-kubernetes-app/master/deployment/hello-kubernetes.yaml" target="_blank" rel="external">url</a> and copy and pasting the source</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -o ./hello-kubernetes.yaml -k https://raw.githubusercontent.com/wesyao/hello-kubernetes-app/master/deployment/hello-kubernetes.yaml</div></pre></td></tr></table></figure></li><li><p>This manifest file describes to k8s what you want deployed and how the state of the cluster should look like. In this manifest file, we will be deploying the hello-kubernetes-app from dockerhub, requiring that there will be 3 replicas of this pod, and specifying what ports we want to traffic to flow through. We also define a service that exposes an external IP for us to hit once deployed. For more information regarding how to write your own manifest files, see the k8s <a href="https://kubernetes.io/docs/api-reference/v1.8/" target="_blank" rel="external">documentation</a>.</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">kubecutl apply -f hello-kubernetes.yaml</div><div class="line"></div><div class="line">deployment <span class="string">"deployment-hello-kubernetes"</span> configured</div><div class="line">service <span class="string">"service-hello-kubernetes"</span> configured</div></pre></td></tr></table></figure></li><li><p>Verify your deployment was successful. Notice the service-hello-kubernetes is allocating an <code>External IP</code> so that we can access our pods from outside the cluster.</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">kubecutl get pods,svc</div><div class="line"></div><div class="line">NAME                                              READY     STATUS    RESTARTS   AGE</div><div class="line">po/deployment-hello-kubernetes-2906022042-0fxdz   1/1       Running   0          7s</div><div class="line">po/deployment-hello-kubernetes-2906022042-29l3j   1/1       Running   0          7s</div><div class="line">po/deployment-hello-kubernetes-2906022042-kb519   1/1       Running   0          7s</div><div class="line"></div><div class="line">NAME                           TYPE           CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE</div><div class="line">svc/kubernetes                 ClusterIP      10.0.0.1      &lt;none&gt;        443/TCP        9d</div><div class="line">svc/service-hello-kubernetes   LoadBalancer   10.0.138.10   &lt;pending&gt;     80:31934/TCP   7s</div></pre></td></tr></table></figure></li><li><p>Once your service has finished allocating an <code>External IP</code>, you can access this from your favorite browser. Once you enter the <code>External IP</code> in your browser, you should see <code>Hello Kubernetes!</code>.</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">kubectl get svc</div><div class="line"></div><div class="line">NAME                       TYPE           CLUSTER-IP    EXTERNAL-IP      PORT(S)        AGE</div><div class="line">kubernetes                 ClusterIP      10.0.0.1      &lt;none&gt;           443/TCP        9d</div><div class="line">service-hello-kubernetes   LoadBalancer   10.0.138.10   104.42.238.180   80:31934/TCP   5m</div></pre></td></tr></table></figure></li></ol><h1 id="Patting-Yourself-on-the-Back"><a href="#Patting-Yourself-on-the-Back" class="headerlink" title="Patting Yourself on the Back"></a>Patting Yourself on the Back</h1><p>Congratulations! Sometimes it’s hard to remember to stop and smell the roses, but you’ve now stood up your first kubernetes cluster, added monitoring on your nodes, and deployed your first application on your cluster! This is no small feat. There is a vast amount of knowledge and details that weren’t covered here, but there is tons of information on the <a href="https://kubernetes.io/docs/concepts/" target="_blank" rel="external">k8s documentation</a> to give you a deeper dive on the concepts we covered.</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;This guide is meant to streamline you to your first Kubernetes (k8s) cluster on Microsoft Azure, with the essentials to monitor and scale
      
    
    </summary>
    
      <category term="Kubernetes" scheme="http://yoursite.com/categories/Kubernetes/"/>
    
    
      <category term="Kubernetes" scheme="http://yoursite.com/tags/Kubernetes/"/>
    
      <category term="Microservices" scheme="http://yoursite.com/tags/Microservices/"/>
    
      <category term="Orchestrator" scheme="http://yoursite.com/tags/Orchestrator/"/>
    
  </entry>
  
</feed>
